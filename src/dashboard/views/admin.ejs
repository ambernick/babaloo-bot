<!-- src/dashboard/views/admin.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Babaloo Bot</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .admin-badge {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }

    .nav-links {
      display: flex;
      gap: 15px;
    }

    .nav-links a {
      color: #667eea;
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 5px;
      transition: background 0.2s;
    }

    .nav-links a:hover {
      background: #f0f0f0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .stat-icon {
      font-size: 36px;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }

    .content-section {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .content-section h2 {
      color: #667eea;
      margin-bottom: 20px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .search-bar {
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 5px;
      width: 300px;
      font-size: 14px;
    }

    .search-bar:focus {
      outline: none;
      border-color: #667eea;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    th {
      background: #f5f5f5;
      font-weight: 600;
      color: #667eea;
      cursor: pointer;
      user-select: none;
    }

    th:hover {
      background: #ebebeb;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: opacity 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    }

    .btn-success {
      background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-content h3 {
      color: #667eea;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 5px;
      font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .pagination {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    .pagination button {
      padding: 8px 16px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
    }

    .pagination button:hover:not(:disabled) {
      background: #667eea;
      color: white;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination button.active {
      background: #667eea;
      color: white;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .tab:hover {
      color: #667eea;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="display: flex; align-items: center;">
        <h1>üõ°Ô∏è Admin Dashboard</h1>
        <span class="admin-badge">ADMIN</span>
      </div>
      <div class="nav-links">
        <a href="/dashboard">User Dashboard</a>
        <a href="/admin">Admin Panel</a>
        <a href="/logout" class="btn btn-sm">Logout</a>
      </div>
    </header>

    <div id="alert-container"></div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üë•</div>
        <div class="stat-value" id="total-users">-</div>
        <div class="stat-label">Total Users</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-value" id="total-currency">-</div>
        <div class="stat-label">Currency in Circulation</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚≠ê</div>
        <div class="stat-value" id="total-xp">-</div>
        <div class="stat-label">Total XP Earned</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üèÜ</div>
        <div class="stat-value" id="total-achievements">-</div>
        <div class="stat-label">Achievements Unlocked</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üíé</div>
        <div class="stat-value" id="total-premium">-</div>
        <div class="stat-label">Premium Currency</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìù</div>
        <div class="stat-value" id="total-transactions">-</div>
        <div class="stat-label">Total Transactions</div>
      </div>
    </div>

    <div class="content-section">
      <div class="tabs">
        <button class="tab active" data-tab="users">User Management</button>
        <button class="tab" data-tab="shop">Shop Management</button>
        <button class="tab" data-tab="settings">Bot Settings</button>
        <button class="tab" data-tab="command-settings">Command Settings</button>
        <button class="tab" data-tab="stream-notifiers">Stream Notifications</button>
        <button class="tab" data-tab="transactions">Recent Transactions</button>
        <button class="tab" data-tab="leaderboards">Leaderboards</button>
      </div>

      <div id="users-tab" class="tab-content active">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <input type="text" class="search-bar" id="user-search" placeholder="Search users by username or Discord ID...">
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-success btn-sm" onclick="openAwardModal()">Award Resources</button>
            <button class="btn btn-danger btn-sm" onclick="openTakeModal()">Take Resources</button>
            <button class="btn btn-danger btn-sm" onclick="openResetModal()" style="background: linear-gradient(135deg, #c92a2a 0%, #a61e1e 100%);">Reset All Stats</button>
          </div>
        </div>
        <div id="users-list" class="loading">Loading users...</div>
        <div class="pagination" id="users-pagination"></div>
      </div>

      <div id="shop-tab" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;">Shop Items</h3>
          <button class="btn btn-success" onclick="openShopItemModal()">Add New Item</button>
        </div>
        <div id="shop-items-list" class="loading">Loading shop items...</div>
      </div>

      <div id="settings-tab" class="tab-content">
        <h3 style="margin-bottom: 20px;">Bot Configuration</h3>
        <div id="settings-list" class="loading">Loading settings...</div>
      </div>

      <div id="command-settings-tab" class="tab-content">
        <h3 style="margin-bottom: 20px;">Command Settings</h3>
        <p style="color: #666; margin-bottom: 20px;">Configure which commands can be used and where they can be executed.</p>
        <div id="command-settings-list" class="loading">Loading commands...</div>
      </div>

      <div id="stream-notifiers-tab" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;">Stream Notifications</h3>
          <button class="btn btn-success" onclick="openAddNotifierModal()">Add Streamer</button>
        </div>
        <div id="stream-notifiers-list" class="loading">Loading stream notifiers...</div>
      </div>

      <div id="transactions-tab" class="tab-content">
        <div id="transactions-list" class="loading">Loading transactions...</div>
      </div>

      <div id="leaderboards-tab" class="tab-content">
        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
          <button class="btn btn-sm" onclick="loadLeaderboard('currency')">Currency</button>
          <button class="btn btn-sm" onclick="loadLeaderboard('xp')">XP</button>
          <button class="btn btn-sm" onclick="loadLeaderboard('achievements')">Achievements</button>
        </div>
        <div id="leaderboard-list" class="loading">Select a leaderboard category</div>
      </div>
    </div>
  </div>

  <!-- Award Modal -->
  <div id="award-modal" class="modal">
    <div class="modal-content">
      <h3>Award Resources to User</h3>
      <form id="award-form">
        <div class="form-group">
          <label>User (Discord ID or search)</label>
          <input type="text" id="award-user" required placeholder="Enter Discord ID">
        </div>
        <div class="form-group">
          <label>Resource Type</label>
          <select id="award-type" required>
            <option value="currency">Currency (Coins)</option>
            <option value="premium">Premium Currency (Gems)</option>
            <option value="xp">XP</option>
          </select>
        </div>
        <div class="form-group">
          <label>Amount</label>
          <input type="number" id="award-amount" required min="1" placeholder="Amount to award">
        </div>
        <div class="form-group">
          <label>Reason (optional)</label>
          <textarea id="award-reason" rows="3" placeholder="Reason for award..."></textarea>
        </div>
        <div class="action-buttons">
          <button type="submit" class="btn btn-success">Award Resources</button>
          <button type="button" class="btn" onclick="closeAwardModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Take Modal -->
  <div id="take-modal" class="modal">
    <div class="modal-content">
      <h3 style="color: #ff6b6b;">Take Resources from User</h3>
      <form id="take-form">
        <div class="form-group">
          <label>User (Discord ID or search)</label>
          <input type="text" id="take-user" required placeholder="Enter Discord ID">
        </div>
        <div class="form-group">
          <label>Resource Type</label>
          <select id="take-type" required>
            <option value="currency">Currency (Coins)</option>
            <option value="premium">Premium Currency (Gems)</option>
            <option value="xp">XP</option>
          </select>
        </div>
        <div class="form-group">
          <label>Amount</label>
          <input type="number" id="take-amount" required min="1" placeholder="Amount to take">
        </div>
        <div class="form-group">
          <label>Reason (optional)</label>
          <textarea id="take-reason" rows="3" placeholder="Reason for taking resources..."></textarea>
        </div>
        <div class="action-buttons">
          <button type="submit" class="btn btn-danger">Take Resources</button>
          <button type="button" class="btn" onclick="closeTakeModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Reset All Modal -->
  <div id="reset-modal" class="modal">
    <div class="modal-content">
      <h3 style="color: #c92a2a;">‚ö†Ô∏è RESET ALL STATS</h3>
      <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
        <strong style="color: #856404;">WARNING:</strong>
        <p style="color: #856404; margin-top: 10px;">This will permanently delete ALL user data including:</p>
        <ul style="color: #856404; margin-left: 20px; margin-top: 10px;">
          <li>All currency and gems</li>
          <li>All XP and levels</li>
          <li>All achievements</li>
          <li>All transaction history</li>
        </ul>
        <p style="color: #c92a2a; margin-top: 10px; font-weight: bold;">THIS ACTION CANNOT BE UNDONE!</p>
      </div>
      <form id="reset-form">
        <div class="form-group">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="unlink-twitch" style="margin-right: 10px; width: 20px; height: 20px; cursor: pointer;">
            <span style="color: #764ba2; font-weight: bold;">Also unlink all Twitch accounts</span>
          </label>
          <div id="twitch-warning" style="display: none; background: #e3f2fd; border: 2px solid #2196f3; padding: 15px; border-radius: 5px; margin-top: 10px;">
            <p style="color: #1565c0; font-style: italic; margin: 0;">
              "Relink these chains of your own volition. The server must bear the inconvenience of one man's exploit."
            </p>
          </div>
        </div>
        <div class="form-group">
          <label style="color: #c92a2a; font-weight: bold;">Type the following phrase to confirm:</label>
          <p style="font-style: italic; color: #666; margin: 10px 0;">"yes i want to reset everything, return to the past NOW!"</p>
          <input
            type="text"
            id="reset-confirmation"
            required
            placeholder="Type the confirmation phrase exactly..."
            style="border-color: #c92a2a;"
          >
        </div>
        <div class="action-buttons">
          <button type="submit" class="btn btn-danger" style="background: linear-gradient(135deg, #c92a2a 0%, #a61e1e 100%);">RESET EVERYTHING</button>
          <button type="button" class="btn" onclick="closeResetModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Shop Item Modal -->
  <div id="shop-item-modal" class="modal">
    <div class="modal-content">
      <h3 id="shop-modal-title">Add New Shop Item</h3>
      <form id="shop-item-form">
        <input type="hidden" id="shop-item-id">
        <div class="form-group">
          <label>Item Name *</label>
          <input type="text" id="shop-item-name" required placeholder="e.g., Hydrate">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="shop-item-description" rows="3" placeholder="What does this reward do?"></textarea>
        </div>
        <div class="form-group">
          <label>Icon</label>
          <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
            <input type="text" id="shop-item-icon" placeholder="Emoji (e.g., üíß) or image URL" style="flex: 1;">
            <button type="button" class="btn btn-sm" onclick="document.getElementById('icon-upload').click()">Upload Image</button>
          </div>
          <input type="file" id="icon-upload" accept="image/*" style="display: none;">
          <div id="icon-preview" style="margin-top: 10px; text-align: center;">
            <span id="icon-preview-text" style="font-size: 48px;"></span>
            <img id="icon-preview-img" style="max-width: 100px; max-height: 100px; display: none;">
          </div>
        </div>
        <div class="form-group">
          <label>Category</label>
          <select id="shop-item-category">
            <option value="action">Action</option>
            <option value="cosmetic">Cosmetic</option>
            <option value="physical">Physical</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Currency Type</label>
          <select id="shop-item-currency">
            <option value="regular">Regular (ü™ô Coins)</option>
            <option value="premium">Premium (üíé Gems)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Cost *</label>
          <input type="number" id="shop-item-cost" required min="1" placeholder="How much does it cost?">
        </div>
        <div class="form-group">
          <label>Stock (-1 for unlimited)</label>
          <input type="number" id="shop-item-stock" value="-1" placeholder="-1 for unlimited">
        </div>
        <div class="form-group">
          <label>Cooldown (per user)</label>
          <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
              <input type="number" id="shop-item-cooldown-minutes" value="0" min="0" placeholder="Minutes" style="width: 100%;">
              <small style="color: #adadb8;">Minutes</small>
            </div>
            <div style="flex: 1;">
              <input type="number" id="shop-item-cooldown-seconds" value="0" min="0" max="59" placeholder="Seconds" style="width: 100%;">
              <small style="color: #adadb8;">Seconds</small>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="shop-item-requires-input" style="margin-right: 10px; width: 20px; height: 20px; cursor: pointer;">
            <span>Requires user input (e.g., custom message)</span>
          </label>
        </div>
        <div class="form-group" id="input-prompt-group" style="display: none;">
          <label>Input Prompt</label>
          <input type="text" id="shop-item-input-prompt" placeholder="e.g., Enter your message...">
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="shop-item-auto-fulfill" style="margin-right: 10px; width: 20px; height: 20px; cursor: pointer;">
            <span>Auto-fulfill (no manual review needed)</span>
          </label>
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="shop-item-enabled" checked style="margin-right: 10px; width: 20px; height: 20px; cursor: pointer;">
            <span>Enabled (visible in shop)</span>
          </label>
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="shop-item-send-notification" checked style="margin-right: 10px; width: 20px; height: 20px; cursor: pointer;">
            <span>Send chat notification on redemption</span>
          </label>
        </div>
        <div class="action-buttons">
          <button type="submit" class="btn btn-success">Save Item</button>
          <button type="button" class="btn" onclick="closeShopItemModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Stream Notifier Modal -->
  <div id="stream-notifier-modal" class="modal">
    <div class="modal-content">
      <h3 id="notifier-modal-title">Add Stream Notifier</h3>
      <form id="stream-notifier-form">
        <input type="hidden" id="notifier-id">
        <div class="form-group">
          <label>Twitch Username *</label>
          <input type="text" id="notifier-username" required placeholder="e.g., falsettovibrato">
          <small style="color: #adadb8; display: block; margin-top: 5px;">The Twitch username to monitor (without @)</small>
        </div>
        <div class="form-group">
          <label>Custom Message (Optional)</label>
          <textarea id="notifier-message" rows="4" placeholder="Leave empty to use default message. Placeholders: {username}, {title}, {game}, {url}"></textarea>
          <small style="color: #adadb8; display: block; margin-top: 5px;">Example: {username} is now live playing {game}! Watch at {url}</small>
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" id="notifier-enabled" checked>
            <span>Enabled</span>
          </label>
        </div>
        <div class="action-buttons">
          <button type="submit" class="btn btn-success">Save</button>
          <button type="button" class="btn" onclick="closeNotifierModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentPage = 1;
    const USERS_PER_PAGE = 25;

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;

        // Update tab buttons
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');

        // Load data for tab if needed
        if (tabName === 'transactions' && !document.getElementById('transactions-list').dataset.loaded) {
          loadRecentTransactions();
        }
        if (tabName === 'shop' && !document.getElementById('shop-items-list').dataset.loaded) {
          loadShopItems();
        }
        if (tabName === 'settings' && !document.getElementById('settings-list').dataset.loaded) {
          loadSettings();
        }
        if (tabName === 'command-settings' && !document.getElementById('command-settings-list').dataset.loaded) {
          loadCommandSettings();
        }
        if (tabName === 'stream-notifiers' && !document.getElementById('stream-notifiers-list').dataset.loaded) {
          loadStreamNotifiers();
        }
      });
    });

    // Load stats
    async function loadStats() {
      try {
        const [usersRes, currencyRes, xpRes, achievementsRes, premiumRes, transactionsRes] = await Promise.all([
          fetch('/api/admin/stats/users').then(r => r.json()),
          fetch('/api/admin/stats/currency').then(r => r.json()),
          fetch('/api/admin/stats/xp').then(r => r.json()),
          fetch('/api/admin/stats/achievements').then(r => r.json()),
          fetch('/api/admin/stats/premium').then(r => r.json()),
          fetch('/api/admin/stats/transactions').then(r => r.json())
        ]);

        document.getElementById('total-users').textContent = usersRes.count.toLocaleString();
        document.getElementById('total-currency').textContent = currencyRes.total.toLocaleString();
        document.getElementById('total-xp').textContent = xpRes.total.toLocaleString();
        document.getElementById('total-achievements').textContent = achievementsRes.count.toLocaleString();
        document.getElementById('total-premium').textContent = premiumRes.total.toLocaleString();
        document.getElementById('total-transactions').textContent = transactionsRes.count.toLocaleString();
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load users
    async function loadUsers(page = 1) {
      currentPage = page;
      const container = document.getElementById('users-list');
      const searchQuery = document.getElementById('user-search').value;

      try {
        const response = await fetch(`/api/admin/users?page=${page}&limit=${USERS_PER_PAGE}&search=${encodeURIComponent(searchQuery)}`);
        const data = await response.json();

        if (data.users.length === 0) {
          container.innerHTML = '<p>No users found.</p>';
          return;
        }

        const table = `
          <table>
            <thead>
              <tr>
                <th onclick="sortUsers('username')">Username</th>
                <th onclick="sortUsers('discord_id')">Discord ID</th>
                <th onclick="sortUsers('currency')">Currency ü™ô</th>
                <th onclick="sortUsers('premium_currency')">Gems üíé</th>
                <th onclick="sortUsers('xp')">XP ‚≠ê</th>
                <th onclick="sortUsers('level')">Level</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${data.users.map(user => `
                <tr>
                  <td>${user.username}</td>
                  <td>${user.discord_id}</td>
                  <td>${user.currency.toLocaleString()}</td>
                  <td>${user.premium_currency}</td>
                  <td>${user.xp.toLocaleString()}</td>
                  <td>${user.level}</td>
                  <td>
                    <button class="btn btn-sm" onclick="viewUser('${user.discord_id}')">View</button>
                    <button class="btn btn-success btn-sm" onclick="quickAward('${user.discord_id}', '${user.username}')">Award</button>
                    <button class="btn btn-danger btn-sm" onclick="quickTake('${user.discord_id}', '${user.username}')">Take</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

        container.innerHTML = table;

        // Update pagination
        updatePagination(data.pagination);
      } catch (error) {
        console.error('Error loading users:', error);
        container.innerHTML = '<p style="color: red;">Error loading users</p>';
      }
    }

    function updatePagination(pagination) {
      const container = document.getElementById('users-pagination');
      const { page, totalPages } = pagination;

      let html = '';

      html += `<button ${page === 1 ? 'disabled' : ''} onclick="loadUsers(${page - 1})">Previous</button>`;

      for (let i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++) {
        html += `<button class="${i === page ? 'active' : ''}" onclick="loadUsers(${i})">${i}</button>`;
      }

      html += `<button ${page === totalPages ? 'disabled' : ''} onclick="loadUsers(${page + 1})">Next</button>`;

      container.innerHTML = html;
    }

    // Load recent transactions
    async function loadRecentTransactions() {
      const container = document.getElementById('transactions-list');
      container.dataset.loaded = 'true';

      try {
        const response = await fetch('/api/admin/transactions?limit=50');
        const data = await response.json();

        if (data.length === 0) {
          container.innerHTML = '<p>No transactions found.</p>';
          return;
        }

        const table = `
          <table>
            <thead>
              <tr>
                <th>Username</th>
                <th>Type</th>
                <th>Category</th>
                <th>Amount</th>
                <th>Currency Type</th>
                <th>Description</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              ${data.map(t => `
                <tr>
                  <td>${t.username}</td>
                  <td>${t.type === 'earn' ? '‚ûï' : '‚ûñ'} ${t.type}</td>
                  <td>${t.category}</td>
                  <td style="color: ${t.type === 'earn' ? 'green' : 'red'}">
                    ${t.type === 'earn' ? '+' : '-'}${t.amount}
                  </td>
                  <td>${t.currency_type === 'regular' ? 'ü™ô' : 'üíé'}</td>
                  <td>${t.description || '-'}</td>
                  <td>${new Date(t.created_at).toLocaleString()}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

        container.innerHTML = table;
      } catch (error) {
        console.error('Error loading transactions:', error);
        container.innerHTML = '<p style="color: red;">Error loading transactions</p>';
      }
    }

    // Load leaderboard
    async function loadLeaderboard(category) {
      const container = document.getElementById('leaderboard-list');
      container.innerHTML = '<div class="loading">Loading leaderboard...</div>';

      try {
        const response = await fetch(`/api/leaderboard/${category}?limit=25`);
        const data = await response.json();

        if (data.length === 0) {
          container.innerHTML = '<p>No data available.</p>';
          return;
        }

        let headers = '<th>Rank</th><th>Username</th>';
        let valueKey = '';
        let valueLabel = '';

        switch (category) {
          case 'currency':
            headers += '<th>Currency ü™ô</th>';
            valueKey = 'currency';
            break;
          case 'xp':
            headers += '<th>XP ‚≠ê</th><th>Level</th>';
            valueKey = 'xp';
            break;
          case 'achievements':
            headers += '<th>Achievements üèÜ</th>';
            valueKey = 'count';
            break;
        }

        const table = `
          <table>
            <thead>
              <tr>${headers}</tr>
            </thead>
            <tbody>
              ${data.map((user, index) => {
                let valueCell = '';
                if (category === 'xp') {
                  valueCell = `<td>${user.xp.toLocaleString()}</td><td>${user.level}</td>`;
                } else {
                  valueCell = `<td>${user[valueKey].toLocaleString()}</td>`;
                }

                return `
                  <tr>
                    <td>${index + 1}</td>
                    <td>${user.username}</td>
                    ${valueCell}
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;

        container.innerHTML = table;
      } catch (error) {
        console.error('Error loading leaderboard:', error);
        container.innerHTML = '<p style="color: red;">Error loading leaderboard</p>';
      }
    }

    // Modal functions
    function openAwardModal() {
      document.getElementById('award-modal').classList.add('active');
    }

    function closeAwardModal() {
      document.getElementById('award-modal').classList.remove('active');
      document.getElementById('award-form').reset();
    }

    function quickAward(discordId, username) {
      document.getElementById('award-user').value = discordId;
      document.getElementById('award-user').placeholder = username;
      openAwardModal();
    }

    function openTakeModal() {
      document.getElementById('take-modal').classList.add('active');
    }

    function closeTakeModal() {
      document.getElementById('take-modal').classList.remove('active');
      document.getElementById('take-form').reset();
    }

    function quickTake(discordId, username) {
      document.getElementById('take-user').value = discordId;
      document.getElementById('take-user').placeholder = username;
      openTakeModal();
    }

    function openResetModal() {
      document.getElementById('reset-modal').classList.add('active');
    }

    function closeResetModal() {
      document.getElementById('reset-modal').classList.remove('active');
      document.getElementById('reset-form').reset();
      document.getElementById('twitch-warning').style.display = 'none';
    }

    // Toggle Twitch warning message
    document.getElementById('unlink-twitch').addEventListener('change', (e) => {
      const warning = document.getElementById('twitch-warning');
      warning.style.display = e.target.checked ? 'block' : 'none';
    });

    // Award form submission
    document.getElementById('award-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const discordId = document.getElementById('award-user').value;
      const type = document.getElementById('award-type').value;
      const amount = parseInt(document.getElementById('award-amount').value);
      const reason = document.getElementById('award-reason').value;

      try {
        const response = await fetch('/api/admin/award', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            discordId,
            [type]: amount,
            reason
          })
        });

        const result = await response.json();

        if (result.success) {
          showAlert('Resources awarded successfully!', 'success');
          closeAwardModal();
          loadUsers(currentPage);
          loadStats();
        } else {
          showAlert('Error: ' + (result.error || 'Failed to award resources'), 'error');
        }
      } catch (error) {
        console.error('Error awarding resources:', error);
        showAlert('Error awarding resources', 'error');
      }
    });

    // Take form submission
    document.getElementById('take-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const discordId = document.getElementById('take-user').value;
      const type = document.getElementById('take-type').value;
      const amount = parseInt(document.getElementById('take-amount').value);
      const reason = document.getElementById('take-reason').value;

      try {
        const response = await fetch('/api/admin/take', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            discordId,
            [type]: amount,
            reason
          })
        });

        const result = await response.json();

        if (result.success) {
          showAlert('Resources taken successfully!', 'success');
          closeTakeModal();
          loadUsers(currentPage);
          loadStats();
        } else {
          showAlert('Error: ' + (result.error || 'Failed to take resources'), 'error');
        }
      } catch (error) {
        console.error('Error taking resources:', error);
        showAlert('Error taking resources', 'error');
      }
    });

    // Reset form submission
    document.getElementById('reset-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const confirmation = document.getElementById('reset-confirmation').value;
      const requiredPhrase = 'yes i want to reset everything, return to the past NOW!';
      const unlinkTwitch = document.getElementById('unlink-twitch').checked;

      if (confirmation !== requiredPhrase) {
        showAlert('Confirmation phrase does not match! Reset cancelled.', 'error');
        return;
      }

      let confirmMessage = 'Are you ABSOLUTELY SURE you want to reset ALL stats? This cannot be undone!';
      if (unlinkTwitch) {
        confirmMessage += '\n\nThis will also UNLINK all Twitch accounts!';
      }

      if (!confirm(confirmMessage)) {
        return;
      }

      try {
        const response = await fetch('/api/admin/reset-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ unlinkTwitch })
        });

        const result = await response.json();

        if (result.success) {
          let message = 'All stats have been reset successfully!';
          if (unlinkTwitch) {
            message += ' Twitch accounts have been unlinked.';
          }
          showAlert(message, 'success');
          closeResetModal();
          loadUsers(currentPage);
          loadStats();
        } else {
          showAlert('Error: ' + (result.error || 'Failed to reset stats'), 'error');
        }
      } catch (error) {
        console.error('Error resetting stats:', error);
        showAlert('Error resetting stats', 'error');
      }
    });

    // Show alert
    function showAlert(message, type) {
      const container = document.getElementById('alert-container');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      container.appendChild(alert);

      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    // User search
    document.getElementById('user-search').addEventListener('input', () => {
      loadUsers(1);
    });

    // Sort users (placeholder - would need backend support)
    function sortUsers(column) {
      console.log('Sort by:', column);
      // TODO: Implement sorting on backend
    }

    function viewUser(discordId) {
      // TODO: Implement user detail view
      console.log('View user:', discordId);
    }

    // Shop Management Functions
    async function loadShopItems() {
      const container = document.getElementById('shop-items-list');
      container.dataset.loaded = 'true';

      try {
        const response = await fetch('/api/admin/shop');
        const data = await response.json();

        if (!data.success || data.items.length === 0) {
          container.innerHTML = '<p>No shop items found. Click "Add New Item" to create one!</p>';
          return;
        }

        const table = `
          <table>
            <thead>
              <tr>
                <th>Icon</th>
                <th>Name</th>
                <th>Description</th>
                <th>Cost</th>
                <th>Category</th>
                <th>Stock</th>
                <th>Cooldown</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${data.items.map(item => {
                const icon = item.icon_url || 'üì¶';
                const isImage = icon.startsWith('http://') || icon.startsWith('https://') || icon.startsWith('/');
                const iconHtml = isImage
                  ? `<img src="${icon}" style="max-width: 40px; max-height: 40px;" />`
                  : `<span style="font-size: 24px;">${icon}</span>`;

                // Format cooldown display
                const cooldownSec = item.cooldown_seconds || 0;
                const minutes = Math.floor(cooldownSec / 60);
                const seconds = cooldownSec % 60;
                let cooldownDisplay = '';
                if (cooldownSec === 0) {
                  cooldownDisplay = '-';
                } else if (minutes > 0 && seconds > 0) {
                  cooldownDisplay = `${minutes}m ${seconds}s`;
                } else if (minutes > 0) {
                  cooldownDisplay = `${minutes}m`;
                } else {
                  cooldownDisplay = `${seconds}s`;
                }

                return `
                <tr>
                  <td>${iconHtml}</td>
                  <td><strong>${item.name}</strong></td>
                  <td>${item.description || '-'}</td>
                  <td>${item.cost} ${item.currency_type === 'regular' ? 'ü™ô' : 'üíé'}</td>
                  <td>${item.category}</td>
                  <td>${item.stock === -1 ? '‚àû' : item.stock}</td>
                  <td>${cooldownDisplay}</td>
                  <td>${item.enabled ? '<span style="color: green;">‚úì Enabled</span>' : '<span style="color: red;">‚úó Disabled</span>'}</td>
                  <td>
                    <button class="btn btn-sm" onclick='editShopItem(${JSON.stringify(item)})'>Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteShopItem(${item.id}, '${item.name}')">Delete</button>
                  </td>
                </tr>
              `;
              }).join('')}
            </tbody>
          </table>
        `;

        container.innerHTML = table;
      } catch (error) {
        console.error('Error loading shop items:', error);
        container.innerHTML = '<p style="color: red;">Error loading shop items</p>';
      }
    }

    function openShopItemModal(item = null) {
      const modal = document.getElementById('shop-item-modal');
      const title = document.getElementById('shop-modal-title');

      if (item) {
        title.textContent = 'Edit Shop Item';
        document.getElementById('shop-item-id').value = item.id;
        document.getElementById('shop-item-name').value = item.name;
        document.getElementById('shop-item-description').value = item.description || '';
        document.getElementById('shop-item-icon').value = item.icon_url || '';
        document.getElementById('shop-item-category').value = item.category;
        document.getElementById('shop-item-currency').value = item.currency_type;
        document.getElementById('shop-item-cost').value = item.cost;
        document.getElementById('shop-item-stock').value = item.stock;

        // Split cooldown_seconds into minutes and seconds
        const cooldownSec = item.cooldown_seconds || 0;
        document.getElementById('shop-item-cooldown-minutes').value = Math.floor(cooldownSec / 60);
        document.getElementById('shop-item-cooldown-seconds').value = cooldownSec % 60;

        document.getElementById('shop-item-requires-input').checked = item.requires_input;
        document.getElementById('shop-item-input-prompt').value = item.input_prompt || '';
        document.getElementById('shop-item-auto-fulfill').checked = item.auto_fulfill;
        document.getElementById('shop-item-enabled').checked = item.enabled;
        document.getElementById('shop-item-send-notification').checked = item.send_notification !== false;

        if (item.requires_input) {
          document.getElementById('input-prompt-group').style.display = 'block';
        }

        // Update icon preview
        updateIconPreview(item.icon_url || '');
      } else {
        title.textContent = 'Add New Shop Item';
        document.getElementById('shop-item-form').reset();
        document.getElementById('shop-item-id').value = '';
        document.getElementById('shop-item-enabled').checked = true;
        updateIconPreview('');
      }

      modal.classList.add('active');
    }

    function closeShopItemModal() {
      document.getElementById('shop-item-modal').classList.remove('active');
      document.getElementById('shop-item-form').reset();
      document.getElementById('input-prompt-group').style.display = 'none';
    }

    function editShopItem(item) {
      openShopItemModal(item);
    }

    async function deleteShopItem(itemId, itemName) {
      if (!confirm(`Are you sure you want to delete "${itemName}"? This cannot be undone!`)) {
        return;
      }

      try {
        const response = await fetch(`/api/admin/shop/${itemId}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          showAlert('Shop item deleted successfully!', 'success');
          loadShopItems();
        } else {
          showAlert('Error: ' + (result.error || 'Failed to delete item'), 'error');
        }
      } catch (error) {
        console.error('Error deleting shop item:', error);
        showAlert('Error deleting shop item', 'error');
      }
    }

    // Toggle input prompt visibility
    document.getElementById('shop-item-requires-input').addEventListener('change', (e) => {
      const inputPromptGroup = document.getElementById('input-prompt-group');
      inputPromptGroup.style.display = e.target.checked ? 'block' : 'none';
    });

    // Icon upload handler
    document.getElementById('icon-upload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Validate file size (max 2MB)
      if (file.size > 2 * 1024 * 1024) {
        showAlert('Image must be less than 2MB', 'error');
        return;
      }

      // Show loading
      const iconInput = document.getElementById('shop-item-icon');
      iconInput.value = 'Uploading...';
      iconInput.disabled = true;

      try {
        const formData = new FormData();
        formData.append('icon', file);

        const response = await fetch('/api/admin/upload-icon', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          iconInput.value = result.url;
          updateIconPreview(result.url);
          showAlert('Icon uploaded successfully!', 'success');
        } else {
          showAlert('Error: ' + (result.error || 'Failed to upload icon'), 'error');
          iconInput.value = '';
        }
      } catch (error) {
        console.error('Error uploading icon:', error);
        showAlert('Error uploading icon', 'error');
        iconInput.value = '';
      } finally {
        iconInput.disabled = false;
      }
    });

    // Icon preview handler
    document.getElementById('shop-item-icon').addEventListener('input', (e) => {
      updateIconPreview(e.target.value);
    });

    function updateIconPreview(value) {
      const previewText = document.getElementById('icon-preview-text');
      const previewImg = document.getElementById('icon-preview-img');

      if (!value) {
        previewText.textContent = '';
        previewImg.style.display = 'none';
        return;
      }

      // Check if it's a URL (image) or emoji
      if (value.startsWith('http://') || value.startsWith('https://') || value.startsWith('/')) {
        previewText.textContent = '';
        previewImg.src = value;
        previewImg.style.display = 'block';
      } else {
        previewText.textContent = value;
        previewImg.style.display = 'none';
      }
    }

    // Shop item form submission
    document.getElementById('shop-item-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const itemId = document.getElementById('shop-item-id').value;

      // Combine minutes and seconds into total seconds
      const cooldownMinutes = parseInt(document.getElementById('shop-item-cooldown-minutes').value) || 0;
      const cooldownSeconds = parseInt(document.getElementById('shop-item-cooldown-seconds').value) || 0;
      const totalCooldownSeconds = (cooldownMinutes * 60) + cooldownSeconds;

      const itemData = {
        name: document.getElementById('shop-item-name').value,
        description: document.getElementById('shop-item-description').value,
        icon_url: document.getElementById('shop-item-icon').value,
        category: document.getElementById('shop-item-category').value,
        currency_type: document.getElementById('shop-item-currency').value,
        cost: parseInt(document.getElementById('shop-item-cost').value),
        stock: parseInt(document.getElementById('shop-item-stock').value),
        cooldown_seconds: totalCooldownSeconds,
        requires_input: document.getElementById('shop-item-requires-input').checked,
        input_prompt: document.getElementById('shop-item-input-prompt').value,
        auto_fulfill: document.getElementById('shop-item-auto-fulfill').checked,
        enabled: document.getElementById('shop-item-enabled').checked,
        send_notification: document.getElementById('shop-item-send-notification').checked
      };

      try {
        const url = itemId ? `/api/admin/shop/${itemId}` : '/api/admin/shop';
        const method = itemId ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(itemData)
        });

        const result = await response.json();

        if (result.success) {
          showAlert(`Shop item ${itemId ? 'updated' : 'created'} successfully!`, 'success');
          closeShopItemModal();
          loadShopItems();
        } else {
          showAlert('Error: ' + (result.error || 'Failed to save item'), 'error');
        }
      } catch (error) {
        console.error('Error saving shop item:', error);
        showAlert('Error saving shop item', 'error');
      }
    });

    // Settings Management Functions
    async function loadSettings() {
      const container = document.getElementById('settings-list');
      container.dataset.loaded = 'true';

      try {
        const response = await fetch('/api/admin/settings');
        const data = await response.json();

        if (!data.success || data.settings.length === 0) {
          container.innerHTML = '<p>No settings found.</p>';
          return;
        }

        // Group settings by category
        const categories = {
          xp: { title: 'XP Rewards', settings: [] },
          currency: { title: 'Currency Rewards', settings: [] },
          limits: { title: 'Rate Limits', settings: [] },
          notifications: { title: 'Notification Channels', settings: [] }
        };

        data.settings.forEach(setting => {
          if (categories[setting.category]) {
            categories[setting.category].settings.push(setting);
          }
        });

        let html = '';
        for (const [catKey, category] of Object.entries(categories)) {
          if (category.settings.length === 0) continue;

          html += `
            <div style="margin-bottom: 30px;">
              <h4 style="margin-bottom: 15px; color: #9147ff;">${category.title}</h4>
              <table>
                <thead>
                  <tr>
                    <th style="width: 40%;">Setting</th>
                    <th style="width: 40%;">Value</th>
                    <th style="width: 20%;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${category.settings.map(setting => {
                    // Determine input type based on setting key
                    const isTextSetting = setting.key.includes('channel_id') || setting.key.endsWith('_message') || setting.key.includes('role_id');
                    const inputType = isTextSetting ? 'text' : 'number';
                    const inputAttrs = isTextSetting ? '' : 'min="0" step="1"';

                    return `
                    <tr>
                      <td>
                        <div style="font-weight: 600; margin-bottom: 3px;">${setting.description}</div>
                        <div style="font-size: 12px; color: #adadb8;">${setting.key}</div>
                      </td>
                      <td>
                        <input
                          type="${inputType}"
                          id="setting-${setting.key}"
                          value="${setting.value}"
                          ${inputAttrs}
                          placeholder="${setting.key.includes('channel_id') ? 'Channel ID' : setting.key.includes('role_id') ? 'Role ID or everyone' : ''}"
                          style="width: 100%; max-width: ${isTextSetting ? '300px' : '150px'}; padding: 8px; background: #0e0e10; border: 1px solid #2c2c34; border-radius: 6px; color: #efeff1; font-size: 14px;"
                        />
                      </td>
                      <td>
                        <button
                          class="btn btn-sm"
                          onclick="updateSetting('${setting.key}')"
                        >
                          Save
                        </button>
                      </td>
                    </tr>
                  `}).join('')}
                </tbody>
              </table>
            </div>
          `;
        }

        container.innerHTML = html;
      } catch (error) {
        console.error('Error loading settings:', error);
        container.innerHTML = '<p style="color: red;">Error loading settings</p>';
      }
    }

    async function updateSetting(key) {
      const input = document.getElementById(`setting-${key}`);
      const value = input.value;

      try {
        const response = await fetch(`/api/admin/settings/${key}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ value })
        });

        const result = await response.json();

        if (result.success) {
          showAlert('Setting updated successfully!', 'success');
        } else {
          showAlert('Error: ' + (result.error || 'Failed to update setting'), 'error');
        }
      } catch (error) {
        console.error('Error updating setting:', error);
        showAlert('Error updating setting', 'error');
      }
    }

    // Stream Notifier Functions
    async function loadStreamNotifiers() {
      const container = document.getElementById('stream-notifiers-list');
      container.dataset.loaded = 'true';

      try {
        const response = await fetch('/api/admin/stream-notifiers');
        const data = await response.json();

        if (data.tableNotFound) {
          container.innerHTML = '<p style="color: orange;">‚ö†Ô∏è Stream notifiers table not found. Run migration: <code>node scripts/add-stream-notifier-table.js</code></p>';
          return;
        }

        if (!data.success || data.notifiers.length === 0) {
          container.innerHTML = '<p>No stream notifiers configured. Click "Add Streamer" to add one!</p>';
          return;
        }

        const table = `
          <table>
            <thead>
              <tr>
                <th>Twitch Username</th>
                <th>Custom Message</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${data.notifiers.map(notifier => `
                <tr>
                  <td style="font-weight: 600;">${notifier.twitch_username}</td>
                  <td style="max-width: 400px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    ${notifier.custom_message || '<em style="color: #adadb8;">Default message</em>'}
                  </td>
                  <td>
                    <span class="badge" style="background: ${notifier.enabled ? '#4CAF50' : '#666'};">
                      ${notifier.enabled ? 'Enabled' : 'Disabled'}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-primary" onclick="editNotifier(${notifier.id})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteNotifier(${notifier.id}, '${notifier.twitch_username}')">Delete</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

        container.innerHTML = table;
      } catch (error) {
        console.error('Error loading stream notifiers:', error);
        container.innerHTML = '<p style="color: red;">Error loading stream notifiers</p>';
      }
    }

    function openAddNotifierModal() {
      document.getElementById('notifier-modal-title').textContent = 'Add Stream Notifier';
      document.getElementById('notifier-id').value = '';
      document.getElementById('notifier-username').value = '';
      document.getElementById('notifier-message').value = '';
      document.getElementById('notifier-enabled').checked = true;
      document.getElementById('stream-notifier-modal').style.display = 'flex';
    }

    async function editNotifier(id) {
      try {
        const response = await fetch('/api/admin/stream-notifiers');
        const data = await response.json();
        const notifier = data.notifiers.find(n => n.id === id);

        if (!notifier) {
          showAlert('Notifier not found', 'error');
          return;
        }

        document.getElementById('notifier-modal-title').textContent = 'Edit Stream Notifier';
        document.getElementById('notifier-id').value = notifier.id;
        document.getElementById('notifier-username').value = notifier.twitch_username;
        document.getElementById('notifier-message').value = notifier.custom_message || '';
        document.getElementById('notifier-enabled').checked = notifier.enabled;
        document.getElementById('stream-notifier-modal').style.display = 'flex';
      } catch (error) {
        console.error('Error loading notifier:', error);
        showAlert('Error loading notifier', 'error');
      }
    }

    function closeNotifierModal() {
      document.getElementById('stream-notifier-modal').style.display = 'none';
    }

    async function deleteNotifier(id, username) {
      if (!confirm(`Are you sure you want to delete stream notifications for ${username}?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/admin/stream-notifiers/${id}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          showAlert(`Stream notifier for ${username} deleted successfully!`, 'success');
          loadStreamNotifiers();
        } else {
          showAlert('Error: ' + (result.error || 'Failed to delete notifier'), 'error');
        }
      } catch (error) {
        console.error('Error deleting notifier:', error);
        showAlert('Error deleting notifier', 'error');
      }
    }

    document.getElementById('stream-notifier-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = document.getElementById('notifier-id').value;
      const data = {
        twitch_username: document.getElementById('notifier-username').value.trim(),
        custom_message: document.getElementById('notifier-message').value.trim() || null,
        enabled: document.getElementById('notifier-enabled').checked
      };

      try {
        const url = id ? `/api/admin/stream-notifiers/${id}` : '/api/admin/stream-notifiers';
        const method = id ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
          showAlert(`Stream notifier ${id ? 'updated' : 'added'} successfully!`, 'success');
          closeNotifierModal();
          loadStreamNotifiers();
        } else {
          showAlert('Error: ' + (result.error || `Failed to ${id ? 'update' : 'add'} notifier`), 'error');
        }
      } catch (error) {
        console.error('Error saving notifier:', error);
        showAlert('Error saving notifier', 'error');
      }
    });

    // Command Settings Management Functions
    let allChannels = [];

    async function loadCommandSettings() {
      const container = document.getElementById('command-settings-list');
      container.dataset.loaded = 'true';

      try {
        const [commandsRes, settingsRes, channelsRes] = await Promise.all([
          fetch('/api/admin/commands').then(r => r.json()),
          fetch('/api/admin/command-settings').then(r => r.json()),
          fetch('/api/admin/channels').then(r => r.json())
        ]);

        console.log('Commands Response:', commandsRes);
        console.log('Settings Response:', settingsRes);
        console.log('Channels Response:', channelsRes);

        if (!commandsRes.success) {
          container.innerHTML = '<p style="color: red;">Error loading commands: ' + (commandsRes.error || 'Unknown error') + '</p>';
          return;
        }

        allChannels = channelsRes.success ? channelsRes.channels : [];
        const settingsMap = {};

        if (settingsRes.success) {
          settingsRes.settings.forEach(s => {
            settingsMap[s.command_name] = s;
          });
        }

        const html = commandsRes.commands.map(cmd => {
          const settings = settingsMap[cmd.name];
          const enabled = settings?.enabled === false ? false : true;
          const useWhitelist = settings?.use_whitelist || false;
          const allowedChannels = settings?.allowed_channel_ids || [];
          const blockedChannels = settings?.blocked_channel_ids || [];

          return `
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 2px solid ${enabled ? '#51cf66' : '#ff6b6b'};">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                <div style="flex: 1;">
                  <h4 style="margin: 0 0 5px 0; color: #667eea;">/${cmd.name}</h4>
                  <p style="margin: 0; color: #666; font-size: 14px;">${cmd.description}</p>
                  <span style="display: inline-block; margin-top: 5px; padding: 3px 8px; background: #e0e0e0; border-radius: 4px; font-size: 12px;">${cmd.category}</span>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                  <span style="font-weight: 600; color: ${enabled ? '#51cf66' : '#ff6b6b'};">${enabled ? '‚úÖ Enabled' : '‚ùå Disabled'}</span>
                  <button class="btn btn-sm ${enabled ? 'btn-danger' : 'btn-success'}"
                          onclick="toggleCommand('${cmd.name}', ${enabled})">
                    ${enabled ? 'Disable' : 'Enable'}
                  </button>
                  ${settings ? `<button class="btn btn-sm" onclick="resetCommand('${cmd.name}')">Reset</button>` : ''}
                </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <label style="font-weight: 600; margin-bottom: 8px; display: block; color: #333;">
                    <input type="radio" name="mode-${cmd.name}" ${!useWhitelist ? 'checked' : ''}
                           onchange="setCommandMode('${cmd.name}', false)" style="margin-right: 5px;">
                    Blacklist Mode (block in specific channels)
                  </label>
                  <div id="blacklist-${cmd.name}" style="display: ${!useWhitelist ? 'block' : 'none'};">
                    <select id="blacklist-select-${cmd.name}" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 2px solid #e0e0e0; border-radius: 5px;">
                      <option value="">Select a channel to block...</option>
                      ${allChannels.map(ch => `<option value="${ch.id}">#${ch.name}</option>`).join('')}
                    </select>
                    <button class="btn btn-sm btn-danger" onclick="addToBlacklist('${cmd.name}')">Block Channel</button>
                    <div id="blacklist-list-${cmd.name}" style="margin-top: 10px;">
                      ${blockedChannels.map(chId => {
                        const channel = allChannels.find(c => c.id === chId);
                        return channel ? `
                          <div style="background: white; padding: 8px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                            <span>#${channel.name}</span>
                            <button class="btn btn-sm" style="padding: 4px 8px;" onclick="removeFromBlacklist('${cmd.name}', '${chId}')">Remove</button>
                          </div>
                        ` : '';
                      }).join('') || '<p style="color: #999; font-size: 13px; margin: 5px 0;">No blocked channels</p>'}
                    </div>
                  </div>
                </div>

                <div>
                  <label style="font-weight: 600; margin-bottom: 8px; display: block; color: #333;">
                    <input type="radio" name="mode-${cmd.name}" ${useWhitelist ? 'checked' : ''}
                           onchange="setCommandMode('${cmd.name}', true)" style="margin-right: 5px;">
                    Whitelist Mode (allow only in specific channels)
                  </label>
                  <div id="whitelist-${cmd.name}" style="display: ${useWhitelist ? 'block' : 'none'};">
                    <select id="whitelist-select-${cmd.name}" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 2px solid #e0e0e0; border-radius: 5px;">
                      <option value="">Select a channel to allow...</option>
                      ${allChannels.map(ch => `<option value="${ch.id}">#${ch.name}</option>`).join('')}
                    </select>
                    <button class="btn btn-sm btn-success" onclick="addToWhitelist('${cmd.name}')">Allow Channel</button>
                    <div id="whitelist-list-${cmd.name}" style="margin-top: 10px;">
                      ${allowedChannels.map(chId => {
                        const channel = allChannels.find(c => c.id === chId);
                        return channel ? `
                          <div style="background: white; padding: 8px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                            <span>#${channel.name}</span>
                            <button class="btn btn-sm" style="padding: 4px 8px;" onclick="removeFromWhitelist('${cmd.name}', '${chId}')">Remove</button>
                          </div>
                        ` : '';
                      }).join('') || '<p style="color: #999; font-size: 13px; margin: 5px 0;">No allowed channels (command blocked everywhere)</p>'}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');

        container.innerHTML = html;
      } catch (error) {
        console.error('Error loading command settings:', error);
        container.innerHTML = '<p style="color: red;">Error loading command settings</p>';
      }
    }

    function setCommandMode(commandName, useWhitelist) {
      document.getElementById(`whitelist-${commandName}`).style.display = useWhitelist ? 'block' : 'none';
      document.getElementById(`blacklist-${commandName}`).style.display = useWhitelist ? 'none' : 'block';
    }

    async function toggleCommand(commandName, currentlyEnabled) {
      try {
        const endpoint = currentlyEnabled ? 'disable' : 'enable';
        const response = await fetch(`/api/admin/command-settings/${commandName}/${endpoint}`, {
          method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
          showAlert(`Command /${commandName} ${currentlyEnabled ? 'disabled' : 'enabled'} successfully!`, 'success');
          loadCommandSettings();
        } else {
          showAlert('Error: ' + (result.error || 'Failed to update command'), 'error');
        }
      } catch (error) {
        console.error('Error toggling command:', error);
        showAlert('Error toggling command', 'error');
      }
    }

    async function addToWhitelist(commandName) {
      const select = document.getElementById(`whitelist-select-${commandName}`);
      const channelId = select.value;

      if (!channelId) {
        showAlert('Please select a channel', 'error');
        return;
      }

      try {
        const response = await fetch(`/api/admin/command-settings/${commandName}/whitelist`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channelId })
        });

        const result = await response.json();

        if (result.success) {
          showAlert('Channel added to whitelist', 'success');
          loadCommandSettings();
        } else {
          showAlert('Error: ' + (result.error || 'Failed to add channel'), 'error');
        }
      } catch (error) {
        console.error('Error adding to whitelist:', error);
        showAlert('Error adding to whitelist', 'error');
      }
    }

    async function removeFromWhitelist(commandName, channelId) {
      try {
        const response = await fetch(`/api/admin/command-settings/${commandName}/whitelist/${channelId}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          showAlert('Channel removed from whitelist', 'success');
          loadCommandSettings();
        } else {
          showAlert('Error: ' + (result.error || 'Failed to remove channel'), 'error');
        }
      } catch (error) {
        console.error('Error removing from whitelist:', error);
        showAlert('Error removing from whitelist', 'error');
      }
    }

    async function addToBlacklist(commandName) {
      const select = document.getElementById(`blacklist-select-${commandName}`);
      const channelId = select.value;

      if (!channelId) {
        showAlert('Please select a channel', 'error');
        return;
      }

      try {
        const response = await fetch(`/api/admin/command-settings/${commandName}/blacklist`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channelId })
        });

        const result = await response.json();

        if (result.success) {
          showAlert('Channel added to blacklist', 'success');
          loadCommandSettings();
        } else {
          showAlert('Error: ' + (result.error || 'Failed to add channel'), 'error');
        }
      } catch (error) {
        console.error('Error adding to blacklist:', error);
        showAlert('Error adding to blacklist', 'error');
      }
    }

    async function removeFromBlacklist(commandName, channelId) {
      try {
        const response = await fetch(`/api/admin/command-settings/${commandName}/blacklist/${channelId}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          showAlert('Channel removed from blacklist', 'success');
          loadCommandSettings();
        } else {
          showAlert('Error: ' + (result.error || 'Failed to remove channel'), 'error');
        }
      } catch (error) {
        console.error('Error removing from blacklist:', error);
        showAlert('Error removing from blacklist', 'error');
      }
    }

    async function resetCommand(commandName) {
      if (!confirm(`Reset /${commandName} to default settings (enabled everywhere)?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/admin/command-settings/${commandName}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          showAlert(`Command /${commandName} reset to defaults`, 'success');
          loadCommandSettings();
        } else {
          showAlert('Error: ' + (result.error || 'Failed to reset command'), 'error');
        }
      } catch (error) {
        console.error('Error resetting command:', error);
        showAlert('Error resetting command', 'error');
      }
    }

    // Initialize
    loadStats();
    loadUsers(1);

    // Close modals when clicking outside
    document.getElementById('award-modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) {
        closeAwardModal();
      }
    });

    document.getElementById('take-modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) {
        closeTakeModal();
      }
    });

    document.getElementById('reset-modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) {
        closeResetModal();
      }
    });

    document.getElementById('shop-item-modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) {
        closeShopItemModal();
      }
    });
  </script>
</body>
</html>
